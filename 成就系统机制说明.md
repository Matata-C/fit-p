# 成就系统机制说明

## 核心功能
1. 成就解锁与展示
2. 成就点计算与累加
3. 跨页面成就点更新
4. 成就解锁提示

## 数据结构
### 成就数据
```javascript
// 成就数据结构示例
{
  id: 1,
  name: "减肥达人",
  type: "连续记录",
  condition: "连续7天记录体重",
  reward: "+50成就点",
  points: 50,
  unlocked: false,
  taskType: "weight"
}
```

### 全局成就数据
```javascript
// app.js 中的全局数据
globalData: {
  userInfo: null,
  selectedTabIndex: 0,
  totalAchievementPoints: 0,  // 总成就点数
  achievementPointsUpdated: false,  // 成就点更新标志
  newAchievementPoints: 0  // 新获得的成就点数
}
```

## 成就计算函数
### 日成就
- `calculateDailyExercise()`: 检查当日是否有运动记录
- `calculateDailyDiet()`: 检查当日饮食记录是否达到3次

### 月成就
- `calculateMonthlyExercise()`: 检查当月运动记录是否达到20天
- `calculateMonthlyCheckin()`: 检查是否连续打卡30天
- `calculateMonthlyWeightGoal()`: 检查是否达成月减重目标

### 其他成就
- `calculateWeightAchievement()`: 检查是否连续7天记录体重
- `calculateDietAchievement()`: 检查是否连续7天饮食打卡
- `calculateStepAchievement()`: 检查当日步数是否达到10000步

## 数据存储格式
1. **运动记录**: 以日期为键的对象 `{日期: [记录数组]}`
2. **饮食记录**: 以日期为键的对象 `{日期: [记录数组]}`
3. **体重记录**: 数组格式 `[{date: 日期, weight: 体重}]`
4. **总成就点数**: 保存在本地存储 `totalAchievementPoints` 中

## 成就点管理机制
### 1. 初始化
- 在 app.js 的 `onLaunch` 方法中调用 `initAchievementData()`
- 从本地存储加载总成就点数到全局数据

### 2. 更新机制
- 使用 `updateTotalPoints(newPoints)` 方法更新全局总成就点数
- 该方法会自动保存总成就点数到本地存储
- 同时设置更新标志，通知其他页面

### 3. 跨页面更新
- 当在一个页面解锁成就时，调用 `app.updateTotalPoints(newPoints)`
- 其他页面在 `onShow` 方法中同步全局总成就点数

## checkAchievementChanges 函数步骤
1. 保存当前成就状态
2. 重新计算成就解锁状态
3. 比较前后状态，找出新解锁的成就
4. 累加新获得的成就点
5. 调用 `app.updateTotalPoints(newPoints)` 更新全局总成就点数
6. 显示成就解锁和获得成就点的提示

## 页面同步机制
- 主成就页面 (achievement.js) 在 `onShow` 方法中同步全局总成就点数
- 更多成就页面 (more-achievements.js) 直接调用 `app.updateTotalPoints` 更新全局成就点
- 全局成就数据保存在本地存储中，确保应用重启后数据不丢失