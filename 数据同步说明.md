# 数据同步优化说明

## 问题描述
用户希望分析页的今日核心数据（步数、体重、卡路里、运动时长）与首页记录的数据保持一致。

## 解决方案

### 1. 创建统一数据同步工具 (`utils/dataSync.js`)
- 创建了 `dataSync.js` 工具文件，统一管理数据获取逻辑
- 提供了以下核心函数：
  - `getCurrentDateString()`: 统一日期格式
  - `getTodayExerciseData()`: 获取今日运动数据
  - `getTodayWeight()`: 获取今日体重数据
  - `getTodayCompleteData()`: 获取完整今日数据
  - `getTodayDataWithProgress()`: 获取带进度的今日数据
  - `getTodayExerciseCategories()`: 获取今日运动分类数据（用于饼图）
  - `categorizeExercise()`: 根据运动名称分类运动类型

### 2. 数据获取优先级
- **步数数据**: 优先从微信运动获取，如果没有则从运动记录获取
- **卡路里和时长**: 从运动记录获取，如果步数来自微信运动且没有卡路里数据，则根据步数估算
- **体重数据**: 优先获取今日体重记录，如果没有则获取最新体重记录
- **运动分类数据**: 根据运动记录中的运动名称自动分类，支持有氧运动、力量训练、身体塑形、竞技运动等分类

### 3. 修改的页面和文件

#### 首页 (`pages/index/index.js`)
- 引入 `dataSync` 工具
- 添加 `todaySteps`、`todayCalories`、`todayDuration` 数据字段
- 修改 `loadTodaySteps()` 方法使用统一数据源
- 添加调试功能（长按步数卡片显示调试信息）

#### 首页模板 (`pages/index/index.wxml`)
- 将硬编码的步数 `26447` 替换为动态数据 `{{todaySteps}}`
- 添加调试信息显示区域

#### 分析页面 (`pages/analysis/analysis.js`)
- 引入 `dataSync` 工具
- 修改 `updateCoreData()` 方法使用统一数据源
- 删除重复的 `getCurrentDateString()` 方法
- 优化 `updateExerciseChart()` 方法，支持从微信运动获取历史数据
- 添加 `updatePieChart()` 方法，动态更新饼图数据
- 饼图数据根据今日运动记录自动分类和统计

#### 运动记录页面 (`pages/exercise/exercise.js`)
- 在保存和删除运动记录时设置数据更新标志
- 确保其他页面能够及时获取最新数据

### 4. 数据更新机制
- 使用 `dataUpdated` 存储标志来通知页面数据已更新
- 首页和分析页面在 `onShow` 时检查数据更新标志
- 运动记录和体重记录保存时自动设置更新标志
- 饼图数据会随着运动记录的添加/删除自动更新

### 5. 调试功能
- 长按首页步数卡片可显示调试信息
- 显示当前步数、卡路里、时长、体重、运动分类等数据
- 便于开发时验证数据同步是否正常

## 数据一致性保证

### 步数数据
- 统一从微信运动或运动记录获取
- 分析页面和首页使用相同的数据源和计算逻辑

### 体重数据
- 统一从 `todayWeight` 或 `weightRecords` 获取
- 确保两个页面显示相同的体重值

### 卡路里和运动时长
- 统一从运动记录获取
- 如果只有步数数据，会根据步数估算卡路里

### 运动分类数据
- 根据运动记录中的运动名称自动分类
- 支持分类：有氧运动、力量训练、身体塑形、竞技运动、其他运动
- 饼图显示各分类的相对占比百分比
- 图例显示：运动类型 + 百分比
- 中心显示总卡路里消耗
- 无运动数据时显示"暂无运动数据"

### 进度计算
- 使用统一的目标值和计算逻辑
- 步数目标：10000步
- 运动时长目标：60分钟
- 卡路里目标：400千卡
- 体重目标：50公斤

## 使用说明

1. **正常使用**: 用户无需做任何特殊操作，数据会自动同步
2. **调试模式**: 长按首页步数卡片可查看当前数据状态
3. **数据更新**: 记录运动或体重后，首页和分析页面会自动更新

## 注意事项

1. 微信运动数据需要用户授权才能获取
2. 如果微信运动数据不可用，会自动使用运动记录数据
3. 体重数据会优先显示今日记录，如果没有则显示最新记录
4. 所有数据更新都会触发页面刷新，确保数据一致性
5. 饼图数据会根据实际运动记录动态生成，无数据时显示默认状态

## 故障排除

### 饼图显示空白
1. 检查控制台日志，查看数据获取情况
2. 确认运动记录数据格式正确
3. 检查饼图组件是否正确接收到数据
4. 使用调试功能查看当前数据状态

### 数据不同步
1. 检查数据更新标志是否正确设置
2. 确认页面刷新逻辑正常工作
3. 验证数据同步工具函数返回值
4. 查看运动记录保存/删除时的更新逻辑

### 运动时长显示错误
1. 新版本已修复时长格式问题
2. 旧数据可能需要运行修复脚本
3. 时长现在统一以分钟为单位存储

### 数据修复脚本
如果遇到数据格式问题，可以在微信开发者工具控制台运行 `test_data_fix.js` 脚本：

```javascript
// 在控制台运行
require('./test_data_fix.js')
```

该脚本会：
- 检查并修复现有运动记录的时长格式
- 添加测试数据（如果没有数据）
- 验证数据同步功能
- 输出详细的调试信息 