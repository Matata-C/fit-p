# 云托管部署指南

## 问题分析
错误 `errCode:-501000| errMsg: Service is not activated` 表示云托管服务未激活。

## 解决方案

### 第一步：准备豆包API密钥

1. **获取豆包API密钥**
   - 访问 [火山引擎控制台](https://console.volcengine.com/)
   - 开通豆包API服务
   - 获取 `API Key`、`Secret Key` 和 `Endpoint`

2. **配置环境变量**
   在云托管控制台设置以下环境变量：
   ```
   DOUBAO_API_KEY=你的豆包API密钥
   DOUBAO_SECRET_KEY=你的豆包密钥
   DOUBAO_ENDPOINT=你的豆包端点
   NODE_ENV=production
   ```

### 第二步：部署云托管服务

1. **在微信开发者工具中**
   - 点击"云开发"按钮
   - 选择环境：`cloud1-6g0qn8fo7e746837`

2. **创建云托管服务**
   - 点击"云托管"
   - 点击"新建服务"
   - 服务名称：`ai-chat-service`
   - 选择"代码包上传"

3. **打包上传代码**
   - 将整个 `server/` 文件夹压缩成zip文件
   - 上传到云托管

4. **配置服务参数**
   - 容器端口：`3000`
   - 最小实例数：`0`
   - 最大实例数：`10`
   - CPU：`1核`
   - 内存：`2GB`

5. **部署服务**
   - 点击"部署"
   - 等待5-10分钟完成部署

### 第三步：验证部署

1. **检查服务状态**
   - 在云托管控制台查看服务状态
   - 确保状态为"运行中"

2. **测试API接口**
   - 访问健康检查接口：`/health`
   - 测试豆包API连接：`/api/test-doubao`

### 第四步：配置小程序

确保 `pages/ai-chat/ai-chat.js` 中的云托管调用正确：

```javascript
const response = await wx.cloud.callContainer({
  path: '/api/chat/process',
  method: 'POST',
  header: {
    'content-type': 'application/json; charset=utf-8'
  },
  data: {
    userId: app.globalData.userId || 'test-user-id',
    message: userMessage
  }
});
```

## 常见问题

### 1. 部署失败
- 检查 `Dockerfile` 语法
- 确认 `package.json` 中的依赖正确
- 查看部署日志

### 2. API调用失败
- 确认豆包API密钥配置正确
- 检查网络连接
- 查看服务日志

### 3. 数据库连接失败
- 确认数据库环境变量配置
- 检查数据库服务状态

## 部署完成后

部署成功后，你的AI聊天功能就能正常工作了！错误 `-501000` 会消失，因为云托管服务已经激活。

## 费用说明

- 云托管按实际使用量计费
- 建议设置最小实例数为0，按需启动
- 豆包API按调用次数计费 